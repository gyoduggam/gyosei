<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í–‰ì •ì„œì‚¬ í•©ê²© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by Canvas environment OR user)
        let firebaseConfig = {};
        let canvasProvidedAppId = null;

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            // Running in Google's Canvas environment
            firebaseConfig = JSON.parse(__firebase_config);
            canvasProvidedAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id';
            console.log("Canvas í™˜ê²½ ê°ì§€. Canvas Firebase ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        } else {
            // Running outside Canvas (e.g., GitHub Pages)
            console.warn("Canvas í™˜ê²½ ë³€ìˆ˜ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì œê³µ Firebase ì„¤ì •ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.");
            // IMPORTANT: This is YOUR Firebase project configuration.
            // Replace the values below with your actual Firebase project's config.
            firebaseConfig = {
                apiKey: "AIzaSyCrVYWYnMy4r5bj6aRo4_pqqQnk48LXN20",
                authDomain: "gyosei-981ca.firebaseapp.com",
                projectId: "gyosei-981ca",
                storageBucket: "gyosei-981ca.firebasestorage.app",
                messagingSenderId: "1079457334042",
                appId: "1:1079457334042:web:063551b36f38c2e5dee2a3",
                measurementId: "G-SSJ8Y3GRRD"
            };
            // Fallback for window.appId when not in Canvas
            canvasProvidedAppId = firebaseConfig.projectId || 'default-external-app-id';
        }

        // Make firebaseConfig and appId globally accessible
        window.firebaseConfig = firebaseConfig;
        window.appId = canvasProvidedAppId;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let dbInstance;
        let authInstance;
        window.currentUserId = null; // Global currentUserId, updated by auth state listener
        window.isLoggedIn = false; // Track login status

        // Global data store - populated by Firestore snapshots (this remains the data cache)
        window.db = {
            notes: [],
            errors: [],
            reviewSchedule: [],
            reviewHistory: {}
        };

        window.appReady = new Promise(resolve => {
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    // Initialize Firebase app and services globally ONCE
                    if (!getApps().length) {
                        app = initializeApp(window.firebaseConfig);
                    } else {
                        app = getApp(); // Use the already initialized app
                    }
                    dbInstance = getFirestore(app);
                    authInstance = getAuth(app);

                    // Make Firebase instances globally accessible
                    window.firestoreDb = dbInstance;
                    window.firebaseAuth = authInstance;

                    // Set up auth state observer
                    onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            // User is successfully authenticated (email/password, custom token, or anonymous)
                            window.currentUserId = user.uid;
                            window.isLoggedIn = !user.isAnonymous; // True if not anonymous
                            document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${window.currentUserId}`;
                            document.getElementById('auth-buttons').innerHTML = `
                                <button onclick="window.openModal('auth-modal', 'logout')" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 transition">ë¡œê·¸ì•„ì›ƒ</button>
                            `;
                            console.log("Firebase Auth: User signed in with UID:", window.currentUserId, "Anonymous:", user.isAnonymous);
                            initializeFirestoreListeners(); // Start listening to Firestore
                            resolve(); // Resolve promise when auth is ready
                        } else {
                            // No user is currently signed in. Attempt to sign in.
                            window.currentUserId = null;
                            window.isLoggedIn = false;
                            document.getElementById('user-id-display').textContent = `ë¡œê·¸ì•„ì›ƒ ìƒíƒœ.`;
                            document.getElementById('auth-buttons').innerHTML = `
                                <button onclick="window.openModal('auth-modal', 'login')" class="bg-[#A37E63] text-white px-3 py-1 rounded-md hover:bg-[#8e6a51] transition">ë¡œê·¸ì¸</button>
                                <button onclick="window.openModal('auth-modal', 'signup')" class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition">íšŒì›ê°€ì…</button>
                            `;
                            console.log("Firebase Auth: No user signed in. Attempting sign-in...");

                            // Only attempt anonymous sign-in if not in Canvas (as Canvas handles initialAuthToken)
                            if (typeof __initial_auth_token === 'undefined' || !initialAuthToken) {
                                try {
                                    await signInAnonymously(authInstance);
                                    // onAuthStateChanged will be triggered again with the signed-in anonymous user
                                    console.log("Firebase Auth: Signed in anonymously (fallback).");
                                } catch (signInError) {
                                    console.error("Firebase Auth: Anonymous sign-in failed:", signInError);
                                    document.getElementById('user-id-display').textContent = `ë¡œê·¸ì¸ ì‹¤íŒ¨ (ë¹„ë¡œê·¸ì¸). ë°ì´í„° ì €ì¥ ë¶ˆê°€.`;
                                    document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500">ë¡œê·¸ì¸ ì‹¤íŒ¨. ë°ì´í„° ì €ì¥ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤. Firebase ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                                    console.warn("Firebase Auth: Anonymous sign-in failed. Data persistence will not work without proper authentication.");

                                    initializeFirestoreListeners(); // Still attempt listeners (they will likely fail for writes)
                                    resolve();
                                }
                            } else {
                                // If initialAuthToken exists (Canvas environment), wait for it to take effect
                                // This block ensures Canvas auth works as expected.
                                try {
                                    await signInWithCustomToken(authInstance, initialAuthToken);
                                } catch (e) {
                                     console.error("Canvas provided token sign-in failed:", e);
                                     // Fallback to anonymous if custom token fails in Canvas
                                     await signInAnonymously(authInstance);
                                }
                            }
                        }
                    }, (error) => {
                        console.error("Firebase Auth state change error:", error);
                        document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500">ì¸ì¦ ì‹œìŠ¤í…œ ì˜¤ë¥˜. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                        window.currentUserId = null; // Ensure no invalid UID is used
                        window.isLoggedIn = false;
                        initializeFirestoreListeners(); // Attempt listeners even on auth error
                        resolve(); // Always resolve the promise
                    });

                } catch (e) {
                    console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
                    document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500">Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                    // Resolve promise even on error to allow UI to load partially
                    window.currentUserId = null; // Set to null if initialization completely fails
                    window.isLoggedIn = false;
                    initializeFirestoreListeners(); // Attempt listeners anyway
                    resolve();
                }
            });
        });

        // Global functions for Firestore collection/document references
        // These now correctly use window.currentUserId which is only set on successful auth
        window.getNotesCollectionRef = () => {
            if (!window.currentUserId) { console.warn("Firestore: Attempted to get notes collection without a valid user ID."); }
            return collection(window.firestoreDb, `artifacts/${window.appId}/users/${window.currentUserId || 'anonymous'}/notes`); // Fallback to 'anonymous' if no UID
        };
        window.getErrorsCollectionRef = () => {
            if (!window.currentUserId) { console.warn("Firestore: Attempted to get errors collection without a valid user ID."); }
            return collection(window.firestoreDb, `artifacts/${window.appId}/users/${window.currentUserId || 'anonymous'}/errors`);
        };
        window.getReviewScheduleCollectionRef = () => {
            if (!window.currentUserId) { console.warn("Firestore: Attempted to get review schedule collection without a valid user ID."); }
            return collection(window.firestoreDb, `artifacts/${window.appId}/users/${window.currentUserId || 'anonymous'}/reviewSchedule`);
        };
        window.getReviewHistoryDocRef = () => {
            if (!window.currentUserId) { console.warn("Firestore: Attempted to get review history document without a valid user ID."); }
            return doc(window.firestoreDb, `artifacts/${window.appId}/users/${window.currentUserId || 'anonymous'}/appData/reviewHistoryDoc`);
        };


        async function initializeFirestoreListeners() {
            if (!window.currentUserId) {
                console.warn("ì‚¬ìš©ì IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ Firestore ë¦¬ìŠ¤ë„ˆë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³´ì•ˆ ê·œì¹™ì— ë”°ë¼ ë°ì´í„° ì‘ì—…ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

            console.log("Firestore ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ì¤‘ (ì‚¬ìš©ì ID:", window.currentUserId, ")");

            // Listeners for data changes in Firestore
            onSnapshot(window.getNotesCollectionRef(), (snapshot) => {
                window.db.notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestoreì—ì„œ ë…¸íŠ¸ ë¡œë“œë¨:", window.db.notes);
                window.renderNotesList();
                window.renderCharts();
            }, (error) => console.error("ë…¸íŠ¸ ë¦¬ìŠ¤ë‹ ì˜¤ë¥˜:", error));

            onSnapshot(window.getErrorsCollectionRef(), (snapshot) => {
                window.db.errors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestoreì—ì„œ ì˜¤ë‹µ ë¡œë“œë¨:", window.db.errors);
                window.renderErrorsList();
                window.renderCharts();
            }, (error) => console.error("ì˜¤ë‹µ ë¦¬ìŠ¤ë‹ ì˜¤ë¥˜:", error));

            onSnapshot(window.getReviewScheduleCollectionRef(), (snapshot) => {
                window.db.reviewSchedule = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestoreì—ì„œ ë³µìŠµ ìŠ¤ì¼€ì¤„ ë¡œë“œë¨:", window.db.reviewSchedule);
                window.renderTodayReview();
            }, (error) => console.error("ë³µìŠµ ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤ë‹ ì˜¤ë¥˜:", error));

            onSnapshot(window.getReviewHistoryDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    window.db.reviewHistory = docSnapshot.data().history || {};
                    console.log("Firestoreì—ì„œ ë³µìŠµ ê¸°ë¡ ë¡œë“œë¨:", window.db.reviewHistory);
                } else {
                    window.db.reviewHistory = {};
                    console.log("ë³µìŠµ ê¸°ë¡ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¹„ì–´ìˆëŠ” ìƒíƒœë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
                }
                window.renderCharts();
            }, (error) => console.error("ë³µìŠµ ê¸°ë¡ ë¦¬ìŠ¤ë‹ ì˜¤ë¥˜:", error));
        }
    </script>
    <!-- Chosen Palette: Calm Focus -->
    <!-- Application Structure Plan: ì´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ ì‚¬ìš©ìì˜ ì¼ì¼ í•™ìŠµ íë¦„ì— ìµœì í™”ëœ 'ëŒ€ì‹œë³´ë“œ ì¤‘ì‹¬ êµ¬ì¡°'ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ì—ì„œëŠ” 'ì˜¤ëŠ˜ì˜ ë³µìŠµ' í•­ëª©ì„ ìµœìš°ì„ ìœ¼ë¡œ ë³´ì—¬ì£¼ì–´ ë§¤ì¼ í•´ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ì‘ì—…ì„ ëª…í™•íˆ ì œì‹œí•©ë‹ˆë‹¤. í•˜ë‹¨ì—ëŠ” í•™ìŠµ ì§„í–‰ ìƒí™©ì„ ì§ê´€ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆëŠ” ì°¨íŠ¸ë“¤ì„ ë°°ì¹˜í•˜ì—¬ ë™ê¸°ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ìƒë‹¨ íƒ­ì„ í†µí•´ ì–¸ì œë“ ì§€ 'ë‹¨ê¶Œí™” ë…¸íŠ¸'ë‚˜ 'ì˜¤ë‹µ ë…¸íŠ¸'ì˜ ì „ì²´ ëª©ë¡ì„ ì¡°íšŒí•˜ê±°ë‚˜ ìƒˆë¡œìš´ ë‚´ìš©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë³´ê³ ì„œì˜ ì„ í˜•ì  êµ¬ì¡°ë¥¼ ë”°ë¥´ê¸°ë³´ë‹¤, 'ì˜¤ëŠ˜ í•  ì¼ í™•ì¸ â†’ í•™ìŠµ ìˆ˜í–‰ â†’ ì§„í–‰ ìƒí™© ì ê²€ â†’ ê¸°ë¡ ë° ê´€ë¦¬'ë¼ëŠ” ì‹¤ì œ í•™ìŠµ ì‚¬ì´í´ì— ë§ì¶˜ ì‚¬ìš©ì ì¤‘ì‹¬ì˜ ë¹„ì„ í˜•ì ì´ê³  íš¨ìœ¨ì ì¸ êµ¬ì¡°ì…ë‹ˆë‹¤. -->
    <!-- Visualization & Content Choices:
        - Report Info: ê³¼ëª©ë³„ í•™ìŠµëŸ‰ -> Goal: í•™ìŠµ ë¶„ëŸ‰ ë¹„êµ -> Viz/Presentation: ë„ë„› ì°¨íŠ¸ (Chart.js) -> Interaction: í˜¸ë²„ ì‹œ íˆ´íŒìœ¼ë¡œ ìˆ˜ì¹˜ í™•ì¸ -> Justification: ì „ì²´ í•™ìŠµì—ì„œ ê° ê³¼ëª©ì´ ì°¨ì§€í•˜ëŠ” ë¹„ì¤‘ì„ í•œëˆˆì— íŒŒì•…í•˜ì—¬ ê· í˜• ìˆëŠ” í•™ìŠµ ê³„íš ìˆ˜ë¦½ì„ ë„ì›€.
        - Report Info: ê³¼ëª©ë³„ ì˜¤ë‹µ ìˆ˜ -> Goal: ì·¨ì•½ì  íŒŒì•… -> Viz/Presentation: ë§‰ëŒ€ ì°¨íŠ¸ (Chart.js) -> Interaction: í˜¸ë²„ ì‹œ íˆ´íŒìœ¼ë¡œ ìˆ˜ì¹˜ í™•ì¸ -> Justification: ì–´ë–¤ ê³¼ëª©ì— ë” ì§‘ì¤‘í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•˜ê²Œ ì‹œê°í™”í•˜ì—¬ ì „ëµì  í•™ìŠµì„ ìœ ë„.
        - Report Info: ì¼ë³„ ë³µìŠµ ì™„ë£Œ ìˆ˜ -> Goal: í•™ìŠµ ê¾¸ì¤€í•¨ ì¶”ì  -> Viz/Presentation: ë¼ì¸ ì°¨íŠ¸ (Chart.js) -> Interaction: í˜¸ë²„ ì‹œ íˆ´íŒìœ¼ë¡œ ìˆ˜ì¹˜ í™•ì¸ -> Justification: ë§¤ì¼ì˜ ë³µìŠµ ì„±ê³¼ë¥¼ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì£¼ì–´ í•™ìŠµ ìŠµê´€ í˜•ì„±ì„ ê²©ë ¤í•˜ê³  ì„±ì·¨ê°ì„ ì œê³µ.
        - Report Info: ë‹¨ê¶Œí™”/ì˜¤ë‹µ ë…¸íŠ¸ ëª©ë¡ -> Goal: ì •ë³´ ì •ë¦¬ ë° ì¡°íšŒ -> Viz/Presentation: ë™ì  í…Œì´ë¸” (HTML/CSS/JS) -> Interaction: ê²€ìƒ‰, í•„í„°ë§, ìƒì„¸ ë³´ê¸° -> Justification: ë°©ëŒ€í•œ í•™ìŠµ ë‚´ìš©ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  í•„ìš”í•  ë•Œ ì‹ ì†í•˜ê²Œ ì°¾ì•„ë³¼ ìˆ˜ ìˆë„ë¡ ì§€ì›.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; background-color: #FDFBF7; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 320px; } }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { color: #A37E63; border-color: #A37E63; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal-content-area {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        .scroll-area { max-height: calc(100vh - 250px); }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #A37E63;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-[#A37E63]">í–‰ì •ì„œì‚¬ í•©ê²© ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p id="d-day-counter" class="text-lg text-gray-600 mt-2"></p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">ë¡œê·¸ì¸ ì¤‘...</p>
            <div id="auth-buttons" class="mt-4 flex justify-center space-x-2">
                <!-- Auth buttons will be injected here by JS -->
            </div>
        </header>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="loading-spinner"></div>
            <p class="ml-3 text-lg text-[#A37E63]">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="hidden">
            <!-- Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button onclick="window.changeTab('dashboard')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-[#A37E63] hover:border-[#A37E63] active" data-tab="dashboard">
                        ëŒ€ì‹œë³´ë“œ
                    </button>
                    <button onclick="window.changeTab('notes')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-[#A37E63] hover:border-[#A37E63]" data-tab="notes">
                        ë‹¨ê¶Œí™” ë…¸íŠ¸
                    </button>
                    <button onclick="window.changeTab('errors')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-[#A37E63] hover:border-[#A37E63]" data-tab="errors">
                        ì˜¤ë‹µ ë…¸íŠ¸
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard -->
                <div id="dashboard" class="space-y-8">
                    <section>
                        <h2 class="text-2xl font-semibold mb-4 text-[#B5947C]">ğŸ“ ì˜¤ëŠ˜ì˜ ë³µìŠµ</h2>
                        <div id="today-review-list" class="space-y-3">
                            <!-- Today's review items will be injected here -->
                        </div>
                    </section>

                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-semibold mb-4 text-center text-[#B5947C]">ğŸ“Š ê³¼ëª©ë³„ í•™ìŠµ í˜„í™©</h2>
                            <div class="chart-container"><canvas id="subjectChart"></canvas></div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold mb-4 text-center text-[#B5947C]">ğŸ“‰ ê³¼ëª©ë³„ ì˜¤ë‹µ ìˆ˜</h2>
                            <div class="chart-container"><canvas id="errorChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2">
                             <h2 class="text-2xl font-semibold mb-4 text-center text-[#B5947C]">ğŸ“ˆ ì¼ë³„ ë³µìŠµ ê¸°ë¡</h2>
                            <div class="chart-container"><canvas id="reviewHistoryChart"></canvas></div>
                        </div>
                    </section>
                </div>

                <!-- Notes -->
                <div id="notes" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-semibold text-[#B5947C]">ğŸ“š ë‹¨ê¶Œí™” ë…¸íŠ¸ ëª©ë¡</h2>
                        <button onclick="window.openModal('note-modal')" class="bg-[#A37E63] text-white px-4 py-2 rounded-lg shadow hover:bg-[#8e6a51] transition">ìƒˆ ë…¸íŠ¸ ì¶”ê°€</button>
                    </div>
                    <div id="notes-list" class="scroll-area overflow-y-auto bg-white/50 p-4 rounded-lg"></div>
                </div>

                <!-- Errors -->
                <div id="errors" class="hidden space-y-4">
                     <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-semibold text-[#B5947C]">ğŸ§ ì˜¤ë‹µ ë…¸íŠ¸ ëª©ë¡</h2>
                        <button onclick="window.openModal('error-modal')" class="bg-[#A37E63] text-white px-4 py-2 rounded-lg shadow hover:bg-[#8e6a51] transition">ìƒˆ ì˜¤ë‹µ ì¶”ê°€</button>
                    </div>
                    <div id="errors-list" class="scroll-area overflow-y-auto bg-white/50 p-4 rounded-lg"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <form id="note-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold text-[#A37E63]">ë‹¨ê¶Œí™” ë…¸íŠ¸ ì‘ì„±</h3>
                <div class="modal-content-area"> <!-- Scrollable content area -->
                    <input type="hidden" id="note-id">
                    <select id="note-subject" class="w-full p-2 border rounded-md" required>
                        <option value="">ê³¼ëª© ì„ íƒ</option>
                        <option>í—Œë²•</option> <option>í–‰ì •ë²•</option> <option>ë¯¼ë²•</option> <option>ìƒë²•</option> <option>ê¸°ì´ˆë²•í•™</option>
                    </select>
                    <input type="text" id="note-topic" placeholder="ë…¼ì  (ì˜ˆ: í–‰ì •ë²• ì´ë¡ : í–‰ì •ì§€ë„)" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="note-keywords" placeholder="í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)" class="w-full p-2 border rounded-md">
                    <textarea id="note-content" placeholder="ì •ë¦¬ ë‚´ìš©" rows="5" class="w-full p-2 border rounded-md"></textarea>
                    <input type="number" id="note-book-page" placeholder="ê¸°ë³¸ì„œ í˜ì´ì§€" class="w-full p-2 border rounded-md">
                </div>
                <div class="flex justify-end space-x-3 mt-4"> <!-- Buttons always at the bottom -->
                    <button type="button" onclick="window.closeModal('note-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                    <button type="submit" class="px-4 py-2 bg-[#A37E63] text-white rounded-md hover:bg-[#8e6a51]">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <form id="error-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold text-[#A37E63]">ì˜¤ë‹µ ë…¸íŠ¸ ì‘ì„±</h3>
                <div class="modal-content-area"> <!-- Scrollable content area -->
                    <input type="hidden" id="error-id">
                     <select id="error-subject" class="w-full p-2 border rounded-md" required>
                        <option value="">ê³¼ëª© ì„ íƒ</option>
                        <option>í—Œë²•</option> <option>í–‰ì •ë²•</option> <option>ë¯¼ë²•</option> <option>ìƒë²•</option> <option>ê¸°ì´ˆë²•í•™</option>
                    </select>
                    <input type="text" id="error-keywords" placeholder="í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)" class="w-full p-2 border rounded-md"> <!-- NEW: Keywords for error note -->
                    <input type="text" id="error-choice-summary" placeholder="ì„ íƒì§€ ë‚´ìš© ìš”ì•½" class="w-full p-2 border rounded-md" required>
                    <textarea id="error-mistake-point" placeholder="ì°©ì˜¤ í¬ì¸íŠ¸ (ì™œ í‹€ë ¸ëŠ”ì§€ ë¶„ì„)" rows="4" class="w-full p-2 border rounded-md"></textarea>
                    <textarea id="error-commentary" placeholder="í•´ì„¤ ìš”ì•½" rows="3" class="w-full p-2 border rounded-md"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-4"> <!-- Buttons always at the bottom -->
                    <button type="button" onclick="window.closeModal('error-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                    <button type="submit" class="px-4 py-2 bg-[#A37E63] text-white rounded-md hover:bg-[#8e6a51]">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail View Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div id="detail-content" class="p-6 space-y-4 modal-content-area"></div> <!-- Scrollable content area -->
            <div class="flex justify-end p-4 bg-gray-50 rounded-b-lg"> <!-- Buttons always at the bottom -->
                <button type="button" onclick="window.closeModal('detail-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4 text-center">
            <h3 class="text-xl font-bold text-red-600">ì‚­ì œ í™•ì¸</h3>
            <p class="text-gray-700">ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ëœ ë³µìŠµ ìŠ¤ì¼€ì¤„ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</p>
            <div class="flex justify-center space-x-4 mt-4">
                <button type="button" onclick="window.closeModal('delete-confirm-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button type="button" id="confirm-delete-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal (Login/Signup) -->
    <div id="auth-modal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 id="auth-modal-title" class="text-xl font-bold text-[#A37E63]">ë¡œê·¸ì¸</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                    <input type="email" id="auth-email" class="mt-1 w-full p-2 border rounded-md" required>
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="auth-password" class="mt-1 w-full p-2 border rounded-md" required>
                </div>
                <div id="auth-error-message" class="text-red-500 text-sm hidden"></div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" onclick="window.closeModal('auth-modal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                    <button type="submit" id="auth-submit-button" class="px-4 py-2 bg-[#A37E63] text-white rounded-md hover:bg-[#8e6a51]">ë¡œê·¸ì¸</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions from the SDKs loaded in <head>
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global data store - populated by Firestore snapshots (this remains the data cache)
        window.db = {
            notes: [],
            errors: [],
            reviewSchedule: [],
            reviewHistory: {}
        };

        const SUBJECTS = ['í—Œë²•', 'í–‰ì •ë²•', 'ë¯¼ë²•', 'ìƒë²•', 'ê¸°ì´ˆë²•í•™'];
        const CHART_COLORS = ['#B5947C', '#C8AB99', '#DBC3B5', '#E9DCD2', '#F1EAE4'];
        let charts = {};

        // Variables to hold info for deletion confirmation
        let itemToDelete = { type: null, id: null };
        let currentAuthMode = 'login'; // 'login' or 'signup'

        // Wait for Firebase to be ready before proceeding
        window.appReady.then(() => {
            console.log("ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸: Firebase ì¤€ë¹„ ì™„ë£Œ, ì‚¬ìš©ì ID:", window.currentUserId, "ì•± ID:", window.appId);

            // Hide loading spinner and show main content
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            setupDDayCounter();
            renderAll(); // Initial render with potentially loaded data
            
            document.getElementById('note-form').addEventListener('submit', handleNoteFormSubmit);
            document.getElementById('error-form').addEventListener('submit', handleErrorFormSubmit);

            // Set up listener for the confirm delete button
            document.getElementById('confirm-delete-button').addEventListener('click', executeDeletion);

            // Set up listener for the auth form submit
            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
        });

        // --- CORE APP LOGIC ---
        function setupDDayCounter() {
            const examDate = new Date('2025-11-09T00:00:00');
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffTime = examDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('d-day-counter').textContent = `ì‹œí—˜ì¼ê¹Œì§€ D-${diffDays}ì¼`;
        }

        // Expose functions to the global scope for onclick attributes
        window.changeTab = function(tabName) {
            document.querySelectorAll('[data-tab]').forEach(button => button.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            ['dashboard', 'notes', 'errors'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== tabName);
            });
        }

        // Expose renderAll to global scope as well, might be called by other functions
        window.renderAll = function() {
            window.renderTodayReview();
            window.renderNotesList();
            window.renderErrorsList();
            window.renderCharts();
        }

        // --- MODAL HANDLING ---
        window.openModal = function(modalId, modeOrData = null) {
            // Special handling for auth modal
            if (modalId === 'auth-modal') {
                document.getElementById('auth-error-message').classList.add('hidden');
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';

                if (modeOrData === 'login') {
                    currentAuthMode = 'login';
                    document.getElementById('auth-modal-title').textContent = 'ë¡œê·¸ì¸';
                    document.getElementById('auth-submit-button').textContent = 'ë¡œê·¸ì¸';
                    document.getElementById('auth-submit-button').classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    document.getElementById('auth-submit-button').classList.add('bg-[#A37E63]', 'hover:bg-[#8e6a51]');
                } else if (modeOrData === 'signup') {
                    currentAuthMode = 'signup';
                    document.getElementById('auth-modal-title').textContent = 'íšŒì›ê°€ì…';
                    document.getElementById('auth-submit-button').textContent = 'íšŒì›ê°€ì…';
                    document.getElementById('auth-submit-button').classList.remove('bg-[#A37E63]', 'hover:bg-[#8e6a51]');
                    document.getElementById('auth-submit-button').classList.add('bg-blue-500', 'hover:bg-blue-600');
                } else if (modeOrData === 'logout') {
                    handleLogout();
                    return; // Don't open a modal for logout
                }
            }

            const formId = modalId === 'note-modal' ? 'note-form' : (modalId === 'error-modal' ? 'error-form' : null);
            // Only reset if it's a form modal (not detail or confirm)
            if (formId) {
                document.getElementById(formId).reset();
            }

            if (modeOrData && (modalId === 'note-modal' || modalId === 'error-modal' || modalId === 'detail-modal')) { // For edit/detail mode
                 if (modalId === 'note-modal') {
                    document.getElementById('note-id').value = modeOrData.id;
                    document.getElementById('note-subject').value = modeOrData.subject;
                    document.getElementById('note-topic').value = modeOrData.topic;
                    document.getElementById('note-keywords').value = modeOrData.keywords;
                    document.getElementById('note-content').value = modeOrData.content;
                    document.getElementById('note-book-page').value = modeOrData.bookPage;
                } else if (modalId === 'error-modal') {
                    document.getElementById('error-id').value = modeOrData.id;
                    document.getElementById('error-subject').value = modeOrData.subject;
                    document.getElementById('error-keywords').value = modeOrData.keywords; // NEW: Populate keywords for error note
                    document.getElementById('error-choice-summary').value = modeOrData.choiceSummary;
                    document.getElementById('error-mistake-point').value = modeOrData.mistakePoint;
                    document.getElementById('error-commentary').value = modeOrData.commentary;
                } else if (modalId === 'detail-modal') {
                    // detail-modal handled by viewDetail function which populates #detail-content
                    // Just open the modal
                }
            } else { // Clear hidden IDs if opening for a new item
                 if (modalId === 'note-modal') document.getElementById('note-id').value = '';
                 if (modalId === 'error-modal') document.getElementById('error-id').value = '';
            }

            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
            // Clear auth error message when closing auth modal
            if (modalId === 'auth-modal') {
                document.getElementById('auth-error-message').classList.add('hidden');
            }
        }

        // --- AUTHENTICATION OPERATIONS ---
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMessageEl = document.getElementById('auth-error-message');
            errorMessageEl.classList.add('hidden'); // Hide previous errors

            try {
                if (currentAuthMode === 'signup') {
                    await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log("íšŒì›ê°€ì… ì„±ê³µ!");
                    alert("íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); // User-friendly alert
                } else { // 'login'
                    await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log("ë¡œê·¸ì¸ ì„±ê³µ!");
                }
                window.closeModal('auth-modal');
            } catch (error) {
                console.error("ì¸ì¦ ì˜¤ë¥˜:", error.code, error.message);
                let message = "ì¸ì¦ ì‹¤íŒ¨: ";
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        message += 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/invalid-email':
                        message += 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/weak-password':
                        message += 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        message += 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        break;
                    default:
                        message += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
                errorMessageEl.textContent = message;
                errorMessageEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(window.firebaseAuth);
                console.log("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ!");
                // After logout, onAuthStateChanged will be triggered, updating UI
                // Optionally sign in anonymously immediately after logout in external environment for basic functionality
                if (typeof __initial_auth_token === 'undefined' || !initialAuthToken) {
                    await signInAnonymously(window.firebaseAuth);
                }
            } catch (error) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
                alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // User-friendly alert
            }
        }

        // --- FIRESTORE OPERATIONS ---
        async function handleNoteFormSubmit(e) {
            e.preventDefault();
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë…¸íŠ¸ ì €ì¥)"); alert("ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ë…¸íŠ¸ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; } // User-friendly alert

            const noteId = document.getElementById('note-id').value;
            const noteData = {
                subject: document.getElementById('note-subject').value,
                topic: document.getElementById('note-topic').value,
                keywords: document.getElementById('note-keywords').value,
                content: document.getElementById('note-content').value,
                bookPage: document.getElementById('note-book-page').value ? parseInt(document.getElementById('note-book-page').value) : null,
            };

            try {
                if (noteId) { // Update existing note
                    // Preserve original createdAt when updating
                    const originalCreatedAt = window.db.notes.find(n => n.id === noteId)?.createdAt || new Date().toISOString();
                    await setDoc(doc(window.getNotesCollectionRef(), noteId), { ...noteData, createdAt: originalCreatedAt });
                    console.log('ë…¸íŠ¸ê°€ Firestoreì—ì„œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤:', noteId);
                } else { // Add new note
                    const newNoteRef = await addDoc(window.getNotesCollectionRef(), { ...noteData, createdAt: new Date().toISOString() });
                    console.log('ìƒˆ ë…¸íŠ¸ê°€ Firestoreì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:', newNoteRef.id);
                    await addReviewScheduleItem('note', newNoteRef.id, new Date().toISOString()); // Add to review schedule with current timestamp
                }
                window.closeModal('note-modal');
            } catch (e) {
                console.error("ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); // User-friendly alert
            }
        }

        async function handleErrorFormSubmit(e) {
            e.preventDefault();
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜¤ë‹µ ë…¸íŠ¸ ì €ì¥)"); alert("ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ì˜¤ë‹µ ë…¸íŠ¸ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; } // User-friendly alert

            const errorId = document.getElementById('error-id').value;
            const errorData = {
                subject: document.getElementById('error-subject').value,
                keywords: document.getElementById('error-keywords').value, // NEW: Get keywords for error note
                choiceSummary: document.getElementById('error-choice-summary').value,
                mistakePoint: document.getElementById('error-mistake-point').value,
                commentary: document.getElementById('error-commentary').value,
            };

            try {
                if (errorId) { // Update existing error
                    // Preserve original createdAt when updating
                    const originalCreatedAt = window.db.errors.find(err => err.id === errorId)?.createdAt || new Date().toISOString();
                    await setDoc(doc(window.getErrorsCollectionRef(), errorId), { ...errorData, createdAt: originalCreatedAt });
                    console.log('ì˜¤ë‹µ ë…¸íŠ¸ê°€ Firestoreì—ì„œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤:', errorId);
                } else { // Add new error
                    const newErrorRef = await addDoc(window.getErrorsCollectionRef(), { ...errorData, createdAt: new Date().toISOString() });
                    console.log('ìƒˆ ì˜¤ë‹µ ë…¸íŠ¸ê°€ Firestoreì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:', newErrorRef.id);
                    await addReviewScheduleItem('error', newErrorRef.id, new Date().toISOString()); // Add to review schedule with current timestamp
                }
                window.closeModal('error-modal');
            } catch (e) {
                console.error("ì˜¤ë‹µ ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("ì˜¤ë‹µ ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); // User-friendly alert
            }
        }

        async function addReviewScheduleItem(type, itemId, createdAt) {
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³µìŠµ ìŠ¤ì¼€ì¤„ ì¶”ê°€)"); return; }
            const today = new Date().toISOString().split('T')[0];
            try {
                await addDoc(window.getReviewScheduleCollectionRef(), {
                    type: type,
                    itemId: itemId, // Use itemId to prevent conflict with Firestore's doc.id
                    createdAt: createdAt, // Use the creation date of the note/error
                    reviewCount: 0,
                    nextReviewDate: today
                });
                console.log('ë³µìŠµ ìŠ¤ì¼€ì¤„ì— í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:', {type, itemId, nextReviewDate: today});
            } catch (e) {
                console.error("ë³µìŠµ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
            }
        }

        window.markAsReviewed = async function(scheduleId) {
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³µìŠµ ì™„ë£Œ ì²˜ë¦¬)"); alert("ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ë³µìŠµ ì™„ë£Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; } // User-friendly alert

            const item = window.db.reviewSchedule.find(s => s.id === scheduleId);
            if (!item) { console.error("ë³µìŠµ ìŠ¤ì¼€ì¤„ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

            const newReviewCount = item.reviewCount + 1;
            const reviewIntervals = [1, 3, 7, 14, 30]; // Days from creation date

            let nextReviewDate;
            if(newReviewCount <= reviewIntervals.length) {
                const creationDate = new Date(item.createdAt); // Use original creation date
                const nextDate = new Date(creationDate);
                nextDate.setDate(creationDate.getDate() + reviewIntervals[newReviewCount - 1]);
                nextReviewDate = nextDate.toISOString().split('T')[0];
            } else {
                const lastReviewDate = new Date(); // From today
                lastReviewDate.setDate(lastReviewDate.getDate() + 30);
                nextReviewDate = lastReviewDate.toISOString().split('T')[0];
            }

            try {
                await updateDoc(doc(window.getReviewScheduleCollectionRef(), scheduleId), {
                    reviewCount: newReviewCount,
                    nextReviewDate: nextReviewDate
                });
                console.log('í•­ëª© ë³µìŠµ ì™„ë£Œ ë° ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸:', {scheduleId, newReviewCount, nextReviewDate});

                // Update review history in Firestore
                const todayStr = new Date().toISOString().split('T')[0];
                const updatedReviewHistory = { ...window.db.reviewHistory };
                updatedReviewHistory[todayStr] = (updatedReviewHistory[todayStr] || 0) + 1;

                await setDoc(window.getReviewHistoryDocRef(), { history: updatedReviewHistory }, { merge: true });
                console.log('ë³µìŠµ ê¸°ë¡ì´ Firestoreì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (e) {
                console.error("ë³µìŠµ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("ë³µìŠµ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); // User-friendly alert
            }
        }

        // Modified deleteItem to use custom confirm modal
        window.deleteItem = async function(type, docId) {
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‚­ì œ í™•ì¸)"); alert("ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í•­ëª© ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; } // User-friendly alert
            itemToDelete = { type: type, id: docId }; // Store info for deletion
            window.openModal('delete-confirm-modal'); // Open the custom confirmation modal
        }

        // New function to execute deletion after confirmation
        async function executeDeletion() {
            const { type, id } = itemToDelete;

            if (!type || !id) {
                console.error("ì‚­ì œí•  í•­ëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                window.closeModal('delete-confirm-modal');
                return;
            }
            if (!window.currentUserId) { console.error("Firestore ì‘ì—…ì— ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‚­ì œ ì‹¤í–‰)"); return; }

            try {
                // Delete the main item
                if (type === 'note') {
                    await deleteDoc(doc(window.getNotesCollectionRef(), id));
                } else if (type === 'error') {
                    await deleteDoc(doc(window.getErrorsCollectionRef(), id));
                }
                console.log(`${type} í•­ëª©ì´ Firestoreì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤:`, id);

                // Find and delete related review schedule items
                const q = query(window.getReviewScheduleCollectionRef(), where('type', '==', type), where('itemId', '==', id));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (docRef) => {
                    await deleteDoc(docRef.ref);
                    console.log('ê´€ë ¨ ë³µìŠµ ìŠ¤ì¼€ì¤„ í•­ëª©ë„ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤:', docRef.id);
                });

                // Clear stored itemToDelete info
                itemToDelete = { type: null, id: null };
                window.closeModal('delete-confirm-modal');

            } catch (e) {
                console.error("í•­ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                alert("í•­ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); // User-friendly alert
                window.closeModal('delete-confirm-modal'); // Close modal even on error
            }
        }

        // --- RENDER FUNCTIONS (now triggered by Firestore snapshots) ---
        window.renderTodayReview = function() {
            const listEl = document.getElementById('today-review-list');
            const today = new Date().toISOString().split('T')[0];
            const itemsToReview = (window.db.reviewSchedule || []).filter(item => item.nextReviewDate <= today);

            if (itemsToReview.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">ì˜¤ëŠ˜ ë³µìŠµí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            listEl.innerHTML = itemsToReview.map(item => {
                const data = item.type === 'note'
                    ? (window.db.notes || []).find(d => d.id === item.itemId)
                    : (window.db.errors || []).find(d => d.id === item.itemId);
                if (!data) return '';

                // Determine the title based on item type
                let displayTitle;
                if (item.type === 'note') {
                    displayTitle = data.topic;
                } else if (item.type === 'error') {
                    displayTitle = data.keywords || data.choiceSummary; // Prefer keywords, fallback to choiceSummary
                }

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer" onclick="window.viewDetail('${item.type}', '${item.itemId}')">
                        <div>
                            <span class="text-xs font-semibold ${item.type === 'note' ? 'text-blue-500 bg-blue-100' : 'text-red-500 bg-red-100'} px-2 py-1 rounded-full">${item.type === 'note' ? 'ë…¸íŠ¸' : 'ì˜¤ë‹µ'}</span>
                            <span class="ml-3 font-medium">${displayTitle}</span>
                            <span class="text-sm text-gray-500 ml-2">(${data.subject}) - ${item.reviewCount}íšŒ ë³µìŠµ</span>
                        </div>
                        <button onclick="event.stopPropagation(); window.markAsReviewed('${item.id}')" class="px-3 py-1 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition">ë³µìŠµ ì™„ë£Œ</button>
                    </div>
                `;
            }).join('');
        };

        window.renderList = function(type) {
            const listEl = document.getElementById(`${type}s-list`);
            // Ensure dataList is always an array, even if window.db[type+'s'] is undefined
            const dataList = window.db[`${type}s`] || []; 

            if (dataList.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-500 p-4">ì•„ì§ ì¶”ê°€ëœ ${type === 'note' ? 'ë…¸íŠ¸ê°€' : 'ì˜¤ë‹µì´'} ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            listEl.innerHTML = dataList.map(data => {
                // Modified: Use keywords for error notes, fallback to topic/choiceSummary
                const title = (type === 'error' && data.keywords) ? data.keywords : (type === 'note' ? data.topic : data.choiceSummary);

                return `
                    <div class="bg-white p-3 rounded-lg shadow-sm mb-2">
                        <div class="flex justify-between items-start">
                           <div class="flex-1">
                               <p class="font-semibold">${title}</p>
                               <p class="text-sm text-gray-500">${new Date(data.createdAt).toLocaleDateString()} | ${data.subject}</p>
                           </div>
                           <div class="flex space-x-2 ml-2">
                               <button onclick="window.viewDetail('${type}', '${data.id}')" class="px-3 py-1 bg-blue-100 text-blue-600 text-xs rounded-md hover:bg-blue-200">ë³´ê¸°</button>
                               <button onclick="window.openModal('${type}-modal', window.db.${type}s.find(d=>d.id==='${data.id}'))" class="px-3 py-1 bg-yellow-100 text-yellow-600 text-xs rounded-md hover:bg-yellow-200">ìˆ˜ì •</button>
                               <button onclick="window.deleteItem('${type}', '${data.id}')" class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded-md hover:bg-red-200">ì‚­ì œ</button>
                           </div>
                        </div>
                    </div>
                `
            }).join('');
        };

        window.renderNotesList = function() { window.renderList('note'); };
        window.renderErrorsList = function() { window.renderList('error'); };

        window.viewDetail = function(type, id) {
            const data = (window.db[`${type}s`] || []).find(d => d.id === id);
            const contentEl = document.getElementById('detail-content');

            if (!data) { contentEl.innerHTML = `<p class="text-red-500">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`; return; }

            let html = `
                <h3 class="text-xl font-bold text-[#A37E63]">${type === 'note' ? 'ë…¸íŠ¸ ìƒì„¸' : 'ì˜¤ë‹µ ìƒì„¸'}</h3>
                <p><strong class="w-24 inline-block">ê³¼ëª©:</strong> ${data.subject}</p>
                <p><strong class="w-24 inline-block">ìƒì„±ì¼:</strong> ${new Date(data.createdAt).toLocaleDateString()}</p>
            `;

            if (type === 'note') {
                html += `
                    <p><strong class="w-24 inline-block">ë…¼ì :</strong> ${data.topic}</p>
                    <p><strong class="w-24 inline-block">í‚¤ì›Œë“œ:</strong> <span class="bg-gray-100 px-2 py-1 rounded">${data.keywords || 'N/A'}</span></p>
                    <p><strong class="w-24 inline-block">ê¸°ë³¸ì„œ í˜ì´ì§€:</strong> ${data.bookPage || 'N/A'}</p>
                    <div class="mt-4 p-4 bg-gray-50 rounded-md">
                        <strong class="block mb-2">ì •ë¦¬ ë‚´ìš©:</strong>
                        <p class="whitespace-pre-wrap">${data.content}</p>
                    </div>
                `;
            } else { // type === 'error'
                 html += `
                    <p><strong class="w-24 inline-block">í‚¤ì›Œë“œ:</strong> <span class="bg-gray-100 px-2 py-1 rounded">${data.keywords || 'N/A'}</span></p> <!-- NEW: Display keywords for error note -->
                    <p><strong class="w-24 inline-block">ì„ íƒì§€:</strong> ${data.choiceSummary}</p>
                    <div class="mt-4 p-4 bg-red-50 rounded-md">
                        <strong class="block mb-2 text-red-700">ì°©ì˜¤ í¬ì¸íŠ¸:</strong>
                        <p class="whitespace-pre-wrap">${data.mistakePoint}</p>
                    </div>
                     <div class="mt-2 p-4 bg-blue-50 rounded-md">
                        <strong class="block mb-2 text-blue-700">í•´ì„¤ ìš”ì•½:</strong>
                        <p class="whitespace-pre-wrap">${data.commentary}</p>
                    </div>
                `;
            }
            contentEl.innerHTML = html;
            window.openModal('detail-modal');
        };

        window.renderCharts = function() {
            renderSubjectChart();
            renderErrorChart();
            renderReviewHistoryChart();
        };

        function renderSubjectChart() {
            const ctx = document.getElementById('subjectChart').getContext('2d');
            const data = {
                labels: SUBJECTS,
                datasets: [{
                    label: 'ê³¼ëª©ë³„ ë…¸íŠ¸ ìˆ˜',
                    data: SUBJECTS.map(s => (window.db.notes || []).filter(n => n.subject === s).length),
                    backgroundColor: CHART_COLORS,
                    borderColor: '#FDFBF7',
                    borderWidth: 2
                }]
            };

            if (charts.subject) charts.subject.destroy();
            charts.subject = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        }

        function renderErrorChart() {
            const ctx = document.getElementById('errorChart').getContext('2d');
            const data = {
                labels: SUBJECTS,
                datasets: [{
                    label: 'ê³¼ëª©ë³„ ì˜¤ë‹µ ìˆ˜',
                    data: SUBJECTS.map(s => (window.db.errors || []).filter(e => e.subject === s).length),
                    backgroundColor: CHART_COLORS[0],
                }]
            };

            if (charts.error) charts.error.destroy();
            charts.error = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        function renderReviewHistoryChart() {
            const ctx = document.getElementById('reviewHistoryChart').getContext('2d');
            const labels = [];
            const dataPoints = [];
            const today = new Date();
            for(let i=14; i>=0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                dataPoints.push((window.db.reviewHistory || {})[dateString] || 0);
            }

            const data = {
                labels: labels,
                datasets: [{
                    label: 'ì¼ë³„ ë³µìŠµ ì™„ë£Œ ìˆ˜',
                    data: dataPoints,
                    fill: true,
                    borderColor: CHART_COLORS[0],
                    backgroundColor: CHART_COLORS[2],
                    tension: 0.1
                }]
            };
            if(charts.history) charts.history.destroy();
            charts.history = new Chart(ctx, {
                type: 'line',
                data: data,
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>

